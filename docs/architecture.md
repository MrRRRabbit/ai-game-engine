# 架构设计文档

## 核心理念

AI Game Engine 不是一个传统游戏引擎，而是 Godot 引擎上的 **AI Shell**。
用户只与 AI Shell 交互，就像普通人用手机不需要懂 Linux 内核一样。

## 分层架构

```
┌─────────────────────────────────────────┐
│           用户界面层                      │
│   自然语言 / 草图 / 语音 / 参考图          │
└──────────────────┬──────────────────────┘
                   ↓
┌─────────────────────────────────────────┐
│           AI 编排层 (核心竞争力)           │
│                                         │
│  ┌──────────┐ ┌──────────┐ ┌─────────┐  │
│  │ 意图理解  │ │ 任务分解  │ │ 代码生成 │  │
│  └──────────┘ └──────────┘ └─────────┘  │
│  ┌──────────┐ ┌──────────┐              │
│  │ 上下文管理│ │ 验证反馈  │              │
│  └──────────┘ └──────────┘              │
└──────────────────┬──────────────────────┘
                   ↓
┌─────────────────────────────────────────┐
│           Godot 引擎层                    │
│                                         │
│  场景树 ← AI 操作的核心接口               │
│  渲染/物理/音频 ← 不改动                  │
│  GDExtension ← AI 运行时模块挂载点       │
└─────────────────────────────────────────┘
```

## AI 后端

当前使用 Claude Code CLI (`claude --print`) 作为 AI 推理后端。

**调用链:**
1. 构建 prompt（system prompt + 项目上下文 + 用户输入）
2. 写入临时文件
3. 通过 shell pipe 传入 `claude --print --output-format text`
4. 解析 JSON 响应
5. 写入 Godot 项目文件
6. 刷新编辑器文件系统

**为什么不用 API SDK:**
Claude Max 订阅的 OAuth token 不兼容 Python SDK，CLI 是官方支持的订阅用户调用方式。

## 文件生成协议

AI 输出的 JSON 格式:

```json
{
  "action": "create | modify",
  "message": "操作描述",
  "files": [
    {
      "path": "res://scenes/main.tscn",
      "content": "文件完整内容"
    }
  ]
}
```

- `create`: 全新项目，包含所有必需文件
- `modify`: 增量修改，只包含变更的文件

## Godot 集成方式

### Phase 1-2: 非侵入式
- CLI 工具: 在 Godot 外部生成文件
- 编辑器插件: 通过 EditorPlugin API 添加 UI，不改引擎核心

### Phase 3+: GDExtension
- 通过 GDExtension 注入 C++/Rust 原生模块
- 用于运行时 AI 能力（NPC、程序化生成等）
- 不需要 fork Godot 源码
