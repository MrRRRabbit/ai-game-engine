#!/bin/bash
# =============================================================================
# AI Game Engine â€” ä¸€é”®æ–°å»ºæ¸¸æˆé¡¹ç›®
#
# ç”¨æ³•:
#   ./tools/new_project.sh <é¡¹ç›®å> [ç›®æ ‡ç›®å½•]
#
# ç¤ºä¾‹:
#   ./tools/new_project.sh my_snake_game
#   ./tools/new_project.sh å¤ªç©ºå°„å‡» ~/GodotGames
#   ./tools/new_project.sh breakout_game ~/Desktop/games
#
# åŠŸèƒ½:
#   1. åœ¨ç›®æ ‡ç›®å½•ä¸‹åˆ›å»ºç©º Godot 4 é¡¹ç›®
#   2. ç¬¦å·é“¾æ¥ addons/ai_engine/ æ’ä»¶ï¼ˆè‡ªåŠ¨åŒæ­¥æ›´æ–°ï¼‰
#   3. é¢„å¯ç”¨æ’ä»¶ï¼ˆæ— éœ€æ‰‹åŠ¨åœ¨ Project Settings ä¸­å‹¾é€‰ï¼‰
#   4. è‡ªåŠ¨ç”¨ Godot æ‰“å¼€é¡¹ç›®
# =============================================================================

set -e

# ---------------------------------------------------------------------------
# é¢œè‰²è¾“å‡º
# ---------------------------------------------------------------------------
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

info()  { echo -e "${GREEN}[âœ“]${NC} $1"; }
warn()  { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[âœ—]${NC} $1"; }
step()  { echo -e "${CYAN}[â†’]${NC} $1"; }

# ---------------------------------------------------------------------------
# å®šä½è„šæœ¬æ‰€åœ¨ç›®å½•ï¼ˆå³ ai-game-engine/tools/ï¼‰
# ---------------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ENGINE_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
ADDON_SOURCE="$ENGINE_ROOT/addons/ai_engine"

# ---------------------------------------------------------------------------
# å‚æ•°è§£æ
# ---------------------------------------------------------------------------
PROJECT_NAME="$1"
TARGET_BASE="${2:-$HOME/GodotGames}"

if [ -z "$PROJECT_NAME" ]; then
    echo ""
    echo "ğŸ® AI Game Engine â€” ä¸€é”®æ–°å»ºæ¸¸æˆé¡¹ç›®"
    echo ""
    echo "ç”¨æ³•: $0 <é¡¹ç›®å> [ç›®æ ‡ç›®å½•]"
    echo ""
    echo "å‚æ•°:"
    echo "  é¡¹ç›®å      æ¸¸æˆé¡¹ç›®åç§°ï¼ˆå¿…å¡«ï¼‰"
    echo "  ç›®æ ‡ç›®å½•    é¡¹ç›®å­˜æ”¾ä½ç½®ï¼ˆå¯é€‰ï¼Œé»˜è®¤: ~/GodotGames/ï¼‰"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 my_snake_game"
    echo "  $0 å¤ªç©ºå°„å‡» ~/Desktop/games"
    echo "  $0 breakout_game /tmp/test_games"
    echo ""
    exit 1
fi

PROJECT_DIR="$TARGET_BASE/$PROJECT_NAME"

# ---------------------------------------------------------------------------
# å‰ç½®æ£€æŸ¥
# ---------------------------------------------------------------------------

# æ£€æŸ¥æ’ä»¶æºç 
if [ ! -d "$ADDON_SOURCE" ]; then
    error "æ‰¾ä¸åˆ°æ’ä»¶ç›®å½•: $ADDON_SOURCE"
    error "è¯·ç¡®ä¿ä» ai-game-engine ä»“åº“çš„ tools/ ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# æ£€æŸ¥é¡¹ç›®æ˜¯å¦å·²å­˜åœ¨
if [ -d "$PROJECT_DIR" ]; then
    error "é¡¹ç›®ç›®å½•å·²å­˜åœ¨: $PROJECT_DIR"
    error "å¦‚éœ€é‡æ–°åˆ›å»ºï¼Œè¯·å…ˆåˆ é™¤è¯¥ç›®å½•"
    exit 1
fi

# æ£€æŸ¥ Godot æ˜¯å¦å®‰è£…
GODOT_APP="/Applications/Godot.app"
HAS_GODOT=false
if [ -d "$GODOT_APP" ]; then
    HAS_GODOT=true
else
    warn "æœªæ‰¾åˆ° Godot.appï¼Œé¡¹ç›®å°†åˆ›å»ºä½†ä¸ä¼šè‡ªåŠ¨æ‰“å¼€"
    warn "è¯·å®‰è£… Godot 4.6+ åæ‰‹åŠ¨æ‰“å¼€é¡¹ç›®"
fi

# ---------------------------------------------------------------------------
# åˆ›å»ºé¡¹ç›®
# ---------------------------------------------------------------------------
echo ""
echo "ğŸ® AI Game Engine â€” æ–°å»ºé¡¹ç›®"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

step "åˆ›å»ºé¡¹ç›®ç›®å½•: $PROJECT_DIR"
mkdir -p "$PROJECT_DIR/addons"

step "ç”Ÿæˆ project.godot"
cat > "$PROJECT_DIR/project.godot" << GODOT_CONFIG
; Engine configuration file.
; Generated by AI Game Engine (tools/new_project.sh)

[application]

config/name="$PROJECT_NAME"
config/features=PackedStringArray("4.4")

[display]

window/size/viewport_width=1152
window/size/viewport_height=648

[editor_plugins]

enabled=PackedStringArray("res://addons/ai_engine/plugin.cfg")

[rendering]

renderer/rendering_method="mobile"
GODOT_CONFIG

step "ç¬¦å·é“¾æ¥æ’ä»¶: addons/ai_engine/ â†’ ä»“åº“æºç "
ln -s "$ADDON_SOURCE" "$PROJECT_DIR/addons/ai_engine"

info "é¡¹ç›®åˆ›å»ºå®Œæˆ!"
echo ""
echo "  ğŸ“ é¡¹ç›®è·¯å¾„: $PROJECT_DIR"
echo "  ğŸ”— æ’ä»¶é“¾æ¥: $PROJECT_DIR/addons/ai_engine â†’ $ADDON_SOURCE"
echo ""

# ---------------------------------------------------------------------------
# ç”¨ Godot æ‰“å¼€é¡¹ç›®
# ---------------------------------------------------------------------------
if [ "$HAS_GODOT" = true ]; then
    step "ç”¨ Godot æ‰“å¼€é¡¹ç›®..."
    open -a Godot --args --path "$PROJECT_DIR"
    echo ""
    info "Godot æ­£åœ¨å¯åŠ¨ï¼Œç­‰å¾…ç¼–è¾‘å™¨åŠ è½½å®Œæˆåï¼š"
    echo "  1. åº•éƒ¨é¢æ¿æ‰¾åˆ° ğŸ® AI Engine"
    echo "  2. è¾“å…¥æ¸¸æˆæè¿°ï¼Œä¾‹å¦‚: 'åšä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆ'"
    echo "  3. æŒ‰ Enter ç”Ÿæˆæ¸¸æˆï¼ŒæŒ‰ F5 è¿è¡Œï¼"
else
    echo ""
    warn "è¯·æ‰‹åŠ¨ç”¨ Godot 4.6+ æ‰“å¼€: $PROJECT_DIR"
fi

echo ""
